#!/bin/bash
# Automated Documentation Submodules Update Script
# Updates all external documentation submodules and commits changes

set -e

DOTFILES_DIR="$HOME/.oh-my-zsh/custom"
LOG_FILE="$HOME/Library/Logs/dotfiles-docs-update.log"

# Function to log messages
log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $1" >> "$LOG_FILE"
}

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

log "Starting external documentation update"

# Navigate to dotfiles directory
if [ ! -d "$DOTFILES_DIR" ]; then
    log "ERROR: Dotfiles directory not found at $DOTFILES_DIR"
    exit 1
fi

cd "$DOTFILES_DIR"

# Check if we're in a git repository
if [ ! -d ".git" ]; then
    log "ERROR: Not in a git repository"
    exit 1
fi

# Check if there are any submodules
if [ ! -f ".gitmodules" ]; then
    log "INFO: No submodules found, nothing to update"
    exit 0
fi

# Update all submodules
log "Updating submodules..."
if output=$(git submodule update --init --recursive --remote 2>&1); then
    log "Submodules updated successfully"
else
    log "ERROR: Failed to update submodules: $output"
    exit 1
fi

# Check if there are any submodule changes to commit
if git diff --quiet --exit-code docs-external/ && git diff --cached --quiet --exit-code docs-external/; then
    log "INFO: No submodule changes to commit"
    exit 0
fi

# Stage and commit submodule changes only
if git add .gitmodules docs-external/ 2>&1; then
    log "Staged submodule changes"
else
    log "ERROR: Failed to stage submodule changes"
    exit 1
fi

# Create commit with submodule updates
commit_msg="chore: Update external documentation submodules [auto]

$(git submodule status | grep -E '^\+' | awk '{print "- " $2 ": updated to " substr($1,2,7)}' || echo '- Updated submodules')"

if git commit -m "$commit_msg" 2>&1; then
    log "SUCCESS: Changes committed successfully"
    
    # Log which submodules were updated
    git show --name-only --pretty="" | grep -E '^docs-external/' | while read -r file; do
        log "  Updated: $file"
    done
else
    log "ERROR: Failed to commit changes"
    exit 1
fi

log "External documentation update completed"