#!/bin/bash

# Chrome profiles directory
CHROME_DIR="$HOME/Library/Application Support/Google/Chrome"
PROFILE_FILE="$HOME/.chrome_profile"

# Function to get profile display name
get_profile_name() {
    local profile_dir="$1"
    if [ -f "$profile_dir/Preferences" ]; then
        python3 -c "
import json
try:
    with open('$profile_dir/Preferences') as f:
        data = json.load(f)
        print(data.get('profile', {}).get('name', 'Unknown'))
except:
    print('Unable to read')
" 2>/dev/null || echo "Unable to read"
    else
        echo "No Preferences file"
    fi
}

# Check if profile is already configured
if [ -f "$PROFILE_FILE" ]; then
    echo "✓ Chrome profile already configured"
    exit 0
fi

# Array to store profile directories
profiles=()
index=1

# Collect available profiles silently
if [ -d "$CHROME_DIR/Default" ]; then
    profiles+=("Default")
    ((index++))
fi

for dir in "$CHROME_DIR"/Profile*; do
    if [ -d "$dir" ]; then
        profile_id=$(basename "$dir")
        profiles+=("$profile_id")
        ((index++))
    fi
done

if [ -d "$CHROME_DIR/Guest Profile" ]; then
    profiles+=("Guest Profile")
    ((index++))
fi

# Use first available profile as default
if [ ${#profiles[@]} -gt 0 ]; then
    selected_profile="${profiles[0]}"
    echo "$selected_profile" > "$PROFILE_FILE"
    echo "✓ Chrome profile configuration completed"
else
    echo "✗ Chrome profile configuration failed - no profiles found"
    exit 1
fi