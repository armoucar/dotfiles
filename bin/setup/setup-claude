#!/bin/bash
# Claude Code Configuration Setup Script
# Links user-specific Claude configuration from dotfiles to ~/.claude

DOTFILES_CLAUDE="$HOME/.oh-my-zsh/custom/config/claude"
GLOBAL_CLAUDE="$HOME/.claude"

# Check if dotfiles config exists
if [ ! -d "$DOTFILES_CLAUDE" ]; then
  echo "✗ Claude configuration failed - config not found at $DOTFILES_CLAUDE" >&2
  exit 1
fi

# Check if settings.json exists in dotfiles
if [ ! -f "$DOTFILES_CLAUDE/settings.json" ]; then
  echo "⚠️  No settings.json found in $DOTFILES_CLAUDE" >&2
  exit 1
fi

# Remove existing ~/.claude if it's a regular directory or broken symlink
if [ -e "$GLOBAL_CLAUDE" ] && [ ! -L "$GLOBAL_CLAUDE" ]; then
  # Backup existing directory
  mv "$GLOBAL_CLAUDE" "$GLOBAL_CLAUDE.backup.$(date +%Y%m%d_%H%M%S)" 2>/dev/null
elif [ -L "$GLOBAL_CLAUDE" ] && [ ! -e "$GLOBAL_CLAUDE" ]; then
  # Remove broken symlink
  rm "$GLOBAL_CLAUDE"
fi

# Create symlink if it doesn't exist or points to wrong location
if [ ! -L "$GLOBAL_CLAUDE" ] || [ "$(readlink "$GLOBAL_CLAUDE")" != "$DOTFILES_CLAUDE" ]; then
  ln -sfn "$DOTFILES_CLAUDE" "$GLOBAL_CLAUDE"
fi

echo "✓ Claude Code configuration linked"