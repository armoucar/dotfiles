#!/bin/bash
# Tmux Configuration Setup Script
# Links tmux configuration using XDG_CONFIG_HOME and installs theme dependencies

DOTFILES_TMUX="$HOME/.oh-my-zsh/custom/config/tmux.conf"
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
XDG_TMUX_DIR="$XDG_CONFIG_HOME/tmux"
XDG_TMUX_CONF="$XDG_TMUX_DIR/tmux.conf"
LEGACY_TMUX="$HOME/.tmux.conf"
TMUX_PLUGINS_DIR="$HOME/.tmux/plugins"
TPM_DIR="$TMUX_PLUGINS_DIR/tpm"
CATPPUCCIN_DIR="$TMUX_PLUGINS_DIR/catppuccin"

# Check if tmux is installed
if ! command -v tmux &> /dev/null; then
  echo "✗ tmux is not installed"
  if command -v brew &> /dev/null; then
    echo "  Install with: brew install tmux"
  else
    echo "  Install tmux for your system"
  fi
  exit 1
fi

# Check if dotfiles config exists
if [ ! -f "$DOTFILES_TMUX" ]; then
  echo "✗ Tmux configuration failed - config not found at $DOTFILES_TMUX"
  exit 1
fi

# Create XDG config directory
mkdir -p "$XDG_TMUX_DIR"

# Remove legacy config if it exists and isn't a symlink to our dotfiles
if [ -f "$LEGACY_TMUX" ] && [ ! -L "$LEGACY_TMUX" ]; then
  # Backup legacy config
  mv "$LEGACY_TMUX" "$LEGACY_TMUX.backup.$(date +%Y%m%d_%H%M%S)" 2>/dev/null
fi

# Create symlink at XDG location if it doesn't exist or points to wrong location
if [ ! -L "$XDG_TMUX_CONF" ] || [ "$(readlink "$XDG_TMUX_CONF")" != "$DOTFILES_TMUX" ]; then
  ln -sfn "$DOTFILES_TMUX" "$XDG_TMUX_CONF"
fi

# Create plugins directory
mkdir -p "$TMUX_PLUGINS_DIR"

# Install TPM (Tmux Plugin Manager)
if [ ! -d "$TPM_DIR" ]; then
  git clone https://github.com/tmux-plugins/tpm "$TPM_DIR" 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "✗ Failed to install TPM"
    exit 1
  fi
fi

# Install Catppuccin theme
if [ ! -d "$CATPPUCCIN_DIR" ]; then
  git clone https://github.com/catppuccin/tmux.git "$CATPPUCCIN_DIR" 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "✗ Failed to install Catppuccin theme"
    exit 1
  fi
fi

# Reload tmux config if tmux is running
if tmux list-sessions &> /dev/null; then
  tmux source-file "$XDG_TMUX_CONF" 2>/dev/null
fi

# Install Nerd Font if not already installed
if ! brew list --cask font-meslo-lg-nerd-font &>/dev/null; then
  if command -v brew &> /dev/null; then
    echo "Installing Meslo Nerd Font..."
    brew install --cask font-meslo-lg-nerd-font 2>/dev/null
    if [ $? -eq 0 ]; then
      if [[ "$TERM_PROGRAM" == "iTerm.app" ]] || [[ "$TERM_PROGRAM" == "Apple_Terminal" ]]; then
        echo "✓ Nerd Font installed - set 'MesloLGS Nerd Font' in your terminal preferences"
      fi
    else
      echo "⚠️  Failed to install Nerd Font - install manually: brew install --cask font-meslo-lg-nerd-font"
    fi
  else
    echo "⚠️  Homebrew not found - install Nerd Font manually for proper theme display"
  fi
fi

echo "✓ Tmux setup complete"