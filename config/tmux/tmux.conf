# Tmux configuration file

# Use both C-\\ and C-b as prefix keys for migration
set-option -g prefix C-\\
set-option -g prefix2 C-b
bind C-\\ send-prefix
bind C-b send-prefix -2

# Clear screen and history with C-l (no prefix needed)
bind-key -n C-l send-keys -R \; send-keys C-l \; clear-history

# Fix Ctrl-C interference - ensure it works as interrupt signal
unbind-key -T root C-c

# Disable kill confirmations
bind -r x kill-pane
bind '&' kill-window
bind K kill-server

# Custom new-window behavior:
# c -> create new window after current window (insert) + prompt for name
# C -> create new window at the end (default behavior) + prompt for name
bind c new-window -a \; command-prompt -p "Window name: " "rename-window '%%'"
bind C new-window \; command-prompt -p "Window name: " "rename-window '%%'"

# Enable vi mode for copy mode
set-window-option -g mode-keys vi

# Enable mouse support with better window switching
set -g mouse on

# Fix mouse window switching - explicit bindings
set -g focus-events on

# Disable automatic clipboard integration to prevent auto-copy
set -g set-clipboard off

# Better defaults
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 250000
set -g status-interval 2
set -g repeat-time 600  # Allow more time for repeated key sequences

# Focus next window instead of previous when closing window
# set-hook -g after-kill-window "run-shell 'tmux select-window -n || true'"

# Activity and bell monitoring for Claude Code notifications
# Keep activity indicators but avoid bells in the current window
set -g monitor-activity on
set -g visual-activity off   # No status messages, only flags/styles
set -g activity-action other # Only flag activity in non-current windows

# Bell monitoring (re-enable for programmatic notifications)
setw -g monitor-bell on
set -g visual-bell off       # Do not flash on bell
set -g bell-action any       # Enable bells across all sessions

# Visual improvements
set -g status-position top

# Quick config reload
bind r source-file ~/.oh-my-zsh/custom/config/tmux/tmux.conf \; display "Config reloaded!"

# Vim-style pane navigation with repeatable keys
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Window navigation with repeatable keys
bind -r n next-window
bind -r p previous-window

# Session navigation with repeatable keys
bind -r '(' switch-client -p
bind -r ')' switch-client -n

# Switch to last active window
bind ';' last-window

# Window reordering shortcuts with repeatable keys
bind -r < swap-window -t -1\; select-window -t -1
bind -r > swap-window -t +1\; select-window -t +1

# Restart current window (respawn-window preserves position and index)
bind R respawn-window -k

# Save tmux window state with Claude bindings
bind S run-shell "tmux-window-state save > /dev/null 2>&1" \; display-message "State saved!"

# Custom fzf-powered switchers with preview
# (Replaced default choose-window and choose-tree)

# Terminal settings for better color support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"

# Catppuccin theme configuration (official recommended defaults)
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Override window text to show window names instead of hostname (fixes common Catppuccin bug)
set -g @catppuccin_window_default_text "#W"   # Inactive windows
set -g @catppuccin_window_current_text "#W"   # Active window
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_current_fill "number"

# Ensure automatic renaming is disabled so custom names stick
set -g automatic-rename off
set -g allow-rename off

# Manual loading of Catppuccin theme (more reliable than TPM)
run '~/.tmux/plugins/catppuccin/catppuccin.tmux'

# Force override tmux window formats after theme loads (fixes Catppuccin hostname bug)
set -g window-status-format "#[fg=#{@thm_surface_2},bg=#{@thm_base}] #I #[fg=#{@thm_fg},bg=#{@thm_base}]#W "
set -g window-status-current-format "#[fg=#{@thm_crust},bg=#{@thm_mauve}] #I #[fg=#{@thm_crust},bg=#{@thm_mauve}]#W "

# Activity and bell window styling (Claude notifications indicator)
set -g window-status-activity-style "fg=#{@thm_peach},bg=#{@thm_base},bold"
set -g window-status-bell-style "fg=#{@thm_crust},bg=#{@thm_yellow},bold"

# Make the status line pretty and add some modules (from official config)
set -g status-left-length 100
set -g status-left ""

set -g status-right-length 100
set -g status-right "#{E:@catppuccin_status_application}"
set -ag status-right " #(~/.oh-my-zsh/custom/bin/tmux/tmux-venv-check)"
# set -agF status-right "#{E:@catppuccin_status_cpu}"
set -ag status-right "#{E:@catppuccin_status_session}"
set -ag status-right "#{E:@catppuccin_status_uptime}"
set -ag status-right " #(~/.oh-my-zsh/custom/bin/tmux/tmux-bell-check)"

# Load tmux-fzf-switcher plugin
run '~/.oh-my-zsh/custom/config/tmux/plugins/tmux-fzf-switcher/tmux-fzf-switcher.tmux'

# Mouse click bindings for better integration
bind-key -T root MouseDown1Status select-window -t =
bind-key -T root MouseDown1Pane select-pane -t =

# Mouse selection bindings for macOS - select only, no auto-copy
# Use Command+C or 'y' key to copy selected text manually
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X stop-selection
bind-key -T copy-mode MouseDragEnd1Pane send-keys -X stop-selection

# Manual copy bindings in copy mode
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode y send-keys -X copy-pipe-and-cancel "pbcopy"

# Double click to select word (no auto-copy)
bind-key -T root DoubleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-word

# Triple click to select line (no auto-copy)
bind-key -T root TripleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-line
