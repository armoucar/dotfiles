# Tmux configuration file

# Use default prefix C-b
set-option -g prefix C-b
bind C-b send-prefix

# Clear screen and history with C-l (no prefix needed)
bind-key -n C-l send-keys -R \; send-keys C-l \; clear-history

# Disable kill confirmations
bind x kill-pane
bind '&' kill-window
bind K kill-server

# Enable vi mode for copy mode
set-window-option -g mode-keys vi

# Enable mouse support
set -g mouse on

# Better defaults
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 250000
set -g status-interval 2

# Focus next window instead of previous when closing window
# set-hook -g after-kill-window "run-shell 'tmux select-window -n || true'"

# Activity and bell monitoring for Claude Code notifications
# Keep activity indicators but avoid bells in the current window
set -g monitor-activity on
set -g visual-activity off   # No status messages, only flags/styles
set -g activity-action other # Only flag activity in non-current windows

# Bell monitoring (re-enable for programmatic notifications)
setw -g monitor-bell on
set -g visual-bell off       # Do not flash on bell
set -g bell-action none      # Ignore all bells completely

# Visual improvements
set -g status-position top

# Quick config reload
bind r source-file ~/.oh-my-zsh/custom/config/tmux.conf \; display "Config reloaded!"

# Vim-style pane navigation with repeatable keys
bind -r h select-pane -L
bind -r j select-pane -D  
bind -r k select-pane -U
bind -r l select-pane -R

# Window navigation with repeatable keys
bind -r n next-window
bind -r p previous-window

# Switch to last active window
bind ';' last-window

# Window reordering shortcuts with repeatable keys
bind -r < swap-window -t -1\; select-window -t -1
bind -r > swap-window -t +1\; select-window -t +1

# Restart current window (respawn-window preserves position and index)
bind R respawn-window -k

# Save tmux window state with Claude bindings
bind S run-shell "tmux-window-state save > /dev/null 2>&1" \; display-message "State saved!"

# Cleaner choose-window format with activity and bell indicators
bind w choose-window -F "#{window_index}: #{window_name}#{window_flags} #{?window_activity_flag,(activity),}#{?window_bell_flag,(bell),}"
bind W choose-tree -F "#{window_name}#{window_flags} #{?window_activity_flag,(activity),}#{?window_bell_flag,(bell),}"

# Terminal settings for better color support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"

# Catppuccin theme configuration (official recommended defaults)
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Override window text to show window names instead of hostname (fixes common Catppuccin bug)
set -g @catppuccin_window_default_text "#W"   # Inactive windows
set -g @catppuccin_window_current_text "#W"   # Active window
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_current_fill "number"

# Ensure automatic renaming is disabled so custom names stick
set -g automatic-rename off
set -g allow-rename off

# Manual loading of Catppuccin theme (more reliable than TPM)
run '~/.tmux/plugins/catppuccin/catppuccin.tmux'

# Force override tmux window formats after theme loads (fixes Catppuccin hostname bug)
set -g window-status-format "#[fg=#{@thm_surface_2},bg=#{@thm_base}] #I #[fg=#{@thm_fg},bg=#{@thm_base}]#W "
set -g window-status-current-format "#[fg=#{@thm_crust},bg=#{@thm_mauve}] #I #[fg=#{@thm_crust},bg=#{@thm_mauve}]#W "

# Activity and bell window styling (Claude notifications indicator)
set -g window-status-activity-style "fg=#{@thm_peach},bg=#{@thm_base},bold"
set -g window-status-bell-style "fg=#{@thm_crust},bg=#{@thm_yellow},bold"

# Make the status line pretty and add some modules (from official config)
set -g status-right-length 100
set -g status-left-length 100
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_application}"
set -agF status-right "#{E:@catppuccin_status_cpu}"
set -ag status-right "#{E:@catppuccin_status_session}"
set -ag status-right "#{E:@catppuccin_status_uptime}"
set -agF status-right "#{E:@catppuccin_status_battery}"

# Cross-session bell indicator - checks all sessions for bells
set -ag status-right "#(tmux list-windows -a -F '#{window_bell_flag}' | grep -c 1 | sed 's/^0$//' | sed 's/^[1-9].*/ðŸ””NEW/')"

# Tmux switcher with fzf - sessions and windows
bind w split-window -v "
{
  echo \"=== SESSIONS ===\"
  tmux list-sessions -F \"session: #{session_name} (#{session_windows} windows)\"
  echo \"\"
  echo \"=== WINDOWS ===\"  
  tmux list-windows -a -F \"window: #{session_name}:#{window_index} #{window_name}#{?window_bell_flag, (NEW),}#{window_flags}\"
} | fzf --reverse --header \"Navigate: Sessions, Windows\" | {
  read selection
  if echo \"\$selection\" | grep -q \"^session:\"; then
    session_name=\$(echo \"\$selection\" | cut -d' ' -f2)
    tmux switch-client -t \"\$session_name\"
  elif echo \"\$selection\" | grep -q \"^window:\"; then
    window_target=\$(echo \"\$selection\" | cut -d' ' -f2)
    session_name=\$(echo \"\$window_target\" | cut -d':' -f1)
    tmux switch-client -t \"\$session_name\"
    tmux select-window -t \"\$window_target\"
  fi
}"
